---
# =======================================================
# Stage 0: Cài đặt Node Exporter (Cho Monitoring)
# =======================================================
- name: "MONITORING: Install Node Exporter on all hosts"
  hosts: all
  become: yes
  tags: [monitoring, node_exporter]
  tasks:
    - name: Install Prometheus Node Exporter
      ansible.builtin.apt: 
        name: prometheus-node-exporter
        state: present
        update_cache: yes

    - name: Ensure Node Exporter is running
      ansible.builtin.service:  
        name: prometheus-node-exporter
        state: started
        enabled: yes
# =======================================================
# Stage 1: Hạ tầng Kubernetes (K3s)
# =======================================================
- name: "K3S: Base & Cluster Setup"
  hosts: all
  become: yes
  tags: [k3s]
  roles:
    - { role: k3s_setup, tags: [setup] }
    - { role: k3s_master, when: "'masters' in group_names", tags: [master] }
    - { role: k3s_worker, when: "'workers' in group_names", tags: [worker] }

# =======================================================
# Stage 2: Cấu hình truy cập (Kubeconfig cho Jenkins)
# =======================================================
- name: "ACCESS: Configure Jenkins Kubeconfig"
  hosts: devops
  become: yes
  tags: [access]
  tasks:
    - name: Create .kube directory for Jenkins
      file: { path: /var/lib/jenkins/.kube, state: directory, owner: jenkins, group: jenkins, mode: "0755" }

    - name: Fetch config from master
      fetch: { src: /etc/rancher/k3s/k3s.yaml, dest: /tmp/k3s_config, flat: yes }
      delegate_to: "{{ groups['masters'][0] }}"

    - name: Deploy kubeconfig to Jenkins
      copy: { src: /tmp/k3s_config, dest: /var/lib/jenkins/.kube/config, owner: jenkins, group: jenkins, mode: "0600" }

    - name: Update Master IP in Jenkins config
      replace:
        path: /var/lib/jenkins/.kube/config
        regexp: '127\.0\.0\.1'
        replace: "{{ hostvars[groups['masters'][0]].ansible_host }}"

# =======================================================
# Stage 3: Giám sát (Prometheus) - Cập nhật tự động Scrape
# =======================================================
- name: "MONITORING: Prometheus"
  hosts: devops
  become: yes
  tags: [monitoring, prometheus]
  tasks:
    - name: Create Prometheus configuration directory
      file: { path: /etc/prometheus, state: directory, mode: '0755' }

    - name: Generate dynamic prometheus.yml
      copy:
        dest: /etc/prometheus/prometheus.yml
        content: |
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
            - job_name: 'k3s-nodes'
              static_configs:
                - targets: [ {% for host in groups['all'] %}'{{ hostvars[host].ansible_host }}:9100'{% if not loop.last %},{% endif %}{% endfor %} ]

    - name: Run Prometheus Container
      community.docker.docker_container:
        name: prometheus
        image: prom/prometheus:latest
        state: started
        restart_policy: always
        published_ports: ["9090:9090"]
        volumes:
          - /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
          - prometheus_data:/prometheus

# =======================================================
# Stage 4: Hiển thị (Grafana)
# =======================================================
- name: "MONITORING: Grafana"
  hosts: devops
  become: yes
  tags: [monitoring, grafana]
  tasks:
    - name: Run Grafana Container
      community.docker.docker_container:
        name: grafana
        image: grafana/grafana:latest
        state: started
        restart_policy: always
        published_ports: ["3000:3000"]
        volumes:
          - grafana_data:/var/lib/grafana

# =======================================================
# Stage 5: Phân tích mã nguồn (SonarQube)
# =======================================================
- name: "SECURITY: SonarQube"
  hosts: devops
  become: yes
  tags: [security, sonarqube]
  tasks:
    - name: Ensure sysctl max_map_count
      ansible.posix.sysctl: { name: vm.max_map_count, value: '262144', state: present, reload: yes }

    - name: Run SonarQube Container
      community.docker.docker_container:
        name: sonarqube
        image: sonarqube:lts-community
        state: started
        restart_policy: always
        published_ports: ["9000:9000"]
        volumes:
          - sonarqube_data:/opt/sonarqube/data
          - sonarqube_extensions:/opt/sonarqube/extensions

# =======================================================
# Stage 6: Quét lỗ hổng (Trivy)
# =======================================================
- name: "SECURITY: Trivy"
  hosts: devops
  become: yes
  tags: [security, trivy]
  tasks:
    - name: "TRIVY: Install prerequisites"
      apt:
        name: [wget, apt-transport-https, gnupg, lsb-release]
        state: present

    - name: "TRIVY: Add GPG key"
      shell: |
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor -o /usr/share/keyrings/trivy.gpg
      args:
        creates: /usr/share/keyrings/trivy.gpg

    - name: "TRIVY: Add Repository"
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb {{ ansible_distribution_release }} main"
        state: present
        filename: trivy
        update_cache: yes

    - name: "TRIVY: Install Trivy package"
      apt: { name: trivy, state: present }

# =======================================================
# Stage E: Deploy (infra + app)
# =======================================================
- name: "DEPLOY: Deploy infrastructure + application"
  hosts: masters
  become: yes
  tags: [deploy]
  tasks:
    - name: ">>> STEP 1: Deploy Infrastructure <<<"
      include_role:
        name: deploy_app
        tasks_from: infrastructure.yml
      tags: [infra]

    - name: ">>> STEP 2: Deploy Backend <<<"
      include_role:
        name: deploy_app
        tasks_from: deployment.yml
      vars:
        target_service: backend
        image_tag: "{{ backend_image_tag | default('latest') }}"
      tags: [backend]

    - name: ">>> STEP 3: Deploy Frontend <<<" 
      include_role:
        name: deploy_app
        tasks_from: deployment.yml
      vars:
        target_service: frontend
        image_tag: "{{ frontend_image_tag | default('latest') }}"
      tags: [frontend]