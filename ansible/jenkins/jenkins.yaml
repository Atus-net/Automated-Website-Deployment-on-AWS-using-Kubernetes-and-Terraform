apiVersion: v1
kind: Namespace
metadata:
  name: jenkins
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: jenkins
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jenkins
  template:
    metadata:
      labels:
        app: jenkins
    spec:
      serviceAccountName: jenkins-admin
      # Ã‰p Jenkins cháº¡y trÃªn Node Monitor (Worker-3)
      nodeSelector:
        role: monitor
      
      # ğŸ‘‡ PHáº¦N Má»šI THÃŠM VÃ€O: Tá»± Ä‘á»™ng sá»­a quyá»n thÆ° má»¥c trÆ°á»›c khi cháº¡y
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ["sh", "-c", "chown -R 1000:1000 /var/jenkins_home"]
        securityContext:
          runAsUser: 0 # Cháº¡y báº±ng quyá»n Root Ä‘á»ƒ sá»­a Ä‘Æ°á»£c thÆ° má»¥c
        volumeMounts:
        - name: jenkins-data
          mountPath: /var/jenkins_home
      # ğŸ‘† Káº¾T THÃšC PHáº¦N Má»šI
      
      containers:
      - name: jenkins
        image: jenkins/jenkins:lts
        ports:
          - containerPort: 8080
        volumeMounts:
          - name: jenkins-data
            mountPath: /var/jenkins_home
      volumes:
        - name: jenkins-data
          hostPath:
            # LÆ°u dá»¯ liá»‡u á»Ÿ thÆ° má»¥c nÃ y trÃªn mÃ¡y Worker
            path: /home/ubuntu/jenkins-data
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: jenkins
  namespace: jenkins
spec:
  type: LoadBalancer
  selector:
    app: jenkins
  ports:
    - name: http
      port: 8081
      targetPort: 8080