---
- name: Get k3s token from master when missing
  become: true
  delegate_to: "{{ groups['masters'][0] }}"
  command: cat /var/lib/rancher/k3s/server/node-token
  register: token_from_master
  changed_when: false
  when: k3s_token is not defined

- name: Set k3s_token fact on worker
  set_fact:
    k3s_token: "{{ token_from_master.stdout }}"
  when: k3s_token is not defined

- name: Wait for Master API reachable from worker (PRIVATE IP)
  wait_for:
    host: "{{ hostvars[groups['masters'][0]]['k3s_server_ip'] }}"
    port: 6443
    timeout: 180
    delay: 3

- name: Join worker to K3s cluster (idempotent)
  become: true
  shell: |
    curl -sfL https://get.k3s.io | sh -
  args:
    creates: /usr/local/bin/k3s-agent
  environment:
    K3S_URL: "https://{{ hostvars[groups['masters'][0]]['k3s_server_ip'] }}:6443"
    K3S_TOKEN: "{{ k3s_token }}"
    # gắn node-name + label role ngay lúc join (đỡ phải chạy play label riêng)
    INSTALL_K3S_EXEC: "agent --node-name {{ inventory_hostname }} --node-label role={{ node_role | default('worker') }}"
