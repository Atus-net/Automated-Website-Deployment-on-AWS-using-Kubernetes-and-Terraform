---
# -------------------------------------------------------
# PH·∫¶N H·∫† T·∫¶NG (Infrastructure)
# -------------------------------------------------------

# 0. D·ªçn d·∫πp Traefik (Safety Net - ƒê·ªÉ ch·∫Øc ch·∫Øn c·ªïng 80 tr·ªëng)
- name: "Remove Default Traefik (To fix Port 80 conflict)"
  shell: |
    kubectl -n kube-system delete service traefik --ignore-not-found
    kubectl -n kube-system delete deployment traefik --ignore-not-found
    kubectl -n kube-system delete job helm-install-traefik --ignore-not-found
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  tags: infra

# 1. T·∫°o Namespace
- name: "T·∫°o Namespace jenkins & k3s-app & ingress-nginx"
  kubernetes.core.k8s:
    name: "{{ item }}"
    kind: Namespace
    state: present
    # üëá ƒê√É S·ª¨A L·ªñI C√ö PH√ÅP ·ªû D√íNG N√ÄY
    kubeconfig: "/etc/rancher/k3s/k3s.yaml"
  with_items:
    - jenkins
    - k3s-app
  tags: infra

# 2. Deploy Ingress Controller (Nginx Custom)
- name: "Deploy Ingress Controller (Nginx Custom)"
  kubernetes.core.k8s:
    state: present
    kubeconfig: "/etc/rancher/k3s/k3s.yaml"
    definition: "{{ lookup('file', '../../../k3s/nginx-custom.yaml') }}"
  tags: infra  # üëà QUAN TR·ªåNG: Ph·∫£i c√≥ tag n√†y

# 2.1 X√≥a Webhook (Fix l·ªói Timeout kinh ƒëi·ªÉn)
- name: "Delete Nginx Validating Webhook (Fix Timeout Error)"
  shell: "kubectl delete validatingwebhookconfigurations ingress-nginx-admission --ignore-not-found"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  tags: infra

# 3. C√†i ƒë·∫∑t Jenkins
- name: "Tri·ªÉn khai Jenkins CI/CD"
  kubernetes.core.k8s:
    state: present
    namespace: jenkins
    kubeconfig: "/etc/rancher/k3s/k3s.yaml"
    definition: "{{ lookup('file', item) }}"
  with_items:
    - "../../../jenkins/jenkins-sa.yaml"
    - "../../../jenkins/jenkins.yaml"
  tags: jenkins

# 4. C√†i ƒë·∫∑t Database & Services n·ªÅn t·∫£ng
- name: "Deploy MongoDB, Monitoring & Services"
  kubernetes.core.k8s:
    state: present
    namespace: k3s-app
    kubeconfig: "/etc/rancher/k3s/k3s.yaml"
    definition: "{{ lookup('file', item) }}"
  with_items:
    - "../../../k3s/mongo-db.yaml"
    - "../../../k3s/monitoring.yaml"
    - "../../../k3s/backend-service.yaml" 
    - "../../../k3s/frontend-service.yaml"
    - "../../../k3s/ingress.yaml"         
  tags: infra