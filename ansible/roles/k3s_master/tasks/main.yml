---
- name: Install K3s on Master (idempotent)
  become: true
  shell: |
    curl -sfL https://get.k3s.io | sh -
  args:
    creates: /usr/local/bin/k3s
  environment:
    INSTALL_K3S_EXEC: >-
      server
      --disable=traefik
      --write-kubeconfig-mode 644
      --tls-san {{ ansible_host }}
      --tls-san {{ k3s_server_ip | default(ansible_default_ipv4.address) }}

- name: Wait for K3s API (6443) to be ready
  become: true
  wait_for:
    host: 127.0.0.1
    port: 6443
    delay: 3
    timeout: 180

- name: Wait for node-token file to be created
  become: true
  wait_for:
    path: /var/lib/rancher/k3s/server/node-token
    timeout: 180

- name: Get Node Token from Master
  become: true
  command: cat /var/lib/rancher/k3s/server/node-token
  register: master_token
  changed_when: false

- name: Share token to workers (delegate facts)
  set_fact:
    k3s_token: "{{ master_token.stdout }}"
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ groups['workers'] }}"
